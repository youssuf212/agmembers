<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membership Sign-up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="w-full max-w-2xl bg-white p-8 rounded-xl shadow-2xl space-y-8">
        <div class="text-center">
            <h1 class="text-4xl font-extrabold text-gray-800">YouTube Membership</h1>
            <p class="text-gray-500 mt-2">Join our exclusive member program and get instant access!</p>
        </div>

        <!-- Sign-up Form -->
        <form id="membershipForm" class="space-y-6">
            <div>
                <label for="memberName" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="memberName" name="memberName" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 transition duration-200">
            </div>
            <div>
                <label for="memberEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                <input type="email" id="memberEmail" name="memberEmail" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 transition duration-200">
            </div>
            <div>
                <label for="youtubeChannel" class="block text-sm font-medium text-gray-700">YouTube Channel Link</label>
                <p class="text-xs text-gray-400 mb-1">We'll use this to verify your membership status.</p>
                <input type="url" id="youtubeChannel" name="youtubeChannel" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 transition duration-200">
            </div>
            <div>
                <label for="membershipTier" class="block text-sm font-medium text-gray-700">Membership Tier</label>
                <select id="membershipTier" name="membershipTier" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 transition duration-200">
                    <option value="Basic">Basic</option>
                    <option value="Gold">Gold</option>
                    <option value="Elite">Elite</option>
                    <option value="Platinum">Platinum</option>
                    <option value="Personal Coaching">Personal Coaching</option>
                    <option value="Personal Coaching+">Personal Coaching+</option>
                    <option value="Personal Coaching++">Personal Coaching++</option>
                </select>
            </div>
            <div>
                <button type="submit" id="submitBtn"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200">
                    Submit Request
                </button>
            </div>
        </form>
    </div>

    <!-- Modal for Success/Loading -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
        <div class="relative bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
            <div id="modalContent">
                <!-- Content will be injected here -->
            </div>
            <button id="closeModalBtn"
                class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-200 hidden">
                Close
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase services
        let app;
        let db;
        let auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase initialization error:", error);
            // Show error message to user
            showModal("Error Initializing App", "There was an error setting up the application. Please try again later.");
        }

        const form = document.getElementById('membershipForm');
        const submitBtn = document.getElementById('submitBtn');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // Function to show the custom modal with dynamic content
        function showModal(title, message, isSuccess = false) {
            modalContent.innerHTML = `
                <div class="text-xl font-semibold">${title}</div>
                <p class="mt-2 text-gray-500">${message}</p>
            `;
            if (isSuccess) {
                closeModalBtn.classList.remove('hidden');
            } else {
                closeModalBtn.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        }

        // Function to hide the custom modal
        function hideModal() {
            modal.classList.add('hidden');
        }

        // Event listener to close the modal
        closeModalBtn.addEventListener('click', hideModal);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Submitting...';

            showModal("Submitting...", "Please wait while we process your request.");

            try {
                // Ensure Firebase is initialized and user is authenticated
                if (!db || !auth) {
                    throw new Error("Firebase services are not initialized.");
                }

                // Sign in anonymously to ensure the user can write to the database
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                const formData = new FormData(form);
                const joinDate = serverTimestamp();
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 30); // 30 days from now

                const newRequest = {
                    name: formData.get('memberName'),
                    email: formData.get('memberEmail'),
                    youtubeChannel: formData.get('youtubeChannel'),
                    tier: formData.get('membershipTier'),
                    joinDate: joinDate,
                    expiryDate: expiryDate,
                    status: 'pending',
                    accessGranted: false,
                    accessGrantedDate: null,
                };

                // Store the new membership request in Firestore
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/memberships`), newRequest);
                console.log("Document successfully written with ID:", docRef.id);

                showModal("Success!", "Your membership request has been submitted successfully. We will review it shortly. You may close this window.");
                submitBtn.classList.add('hidden');
            } catch (error) {
                console.error("Error submitting request:", error);
                showModal("Submission Failed", "There was an error submitting your request. Please try again.");
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Request';
            }
        });
    </script>
</body>
</html>
